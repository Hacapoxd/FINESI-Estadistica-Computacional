<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üç≠ Juego de Dulces</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js "></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f5f9ff;
      color: #333;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #6a11cb;
      color: white;
      font-weight: bold;
    }
    select {
      padding: 8px;
      margin-right: 10px;
    }
    .message {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .player-card {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      background: #fafafa;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>üéÆ Juego de Dulces</h1>
  <p>Canjea dulces por chupetines y juega con tus amigos.</p>
  <button onclick="iniciarJuego()">üîÑ Iniciar Juego</button>

  <div id="gameArea" style="margin-top: 20px;"></div>
</div>

<!-- L√≥gica del juego -->
<script id="py-src" type="text/python">
from collections import defaultdict
import random

TIPOS_DULCES = ['A', 'B', 'C']

class Jugador:
    def __init__(self, nombre):
        self.nombre = nombre
        self.dulces = defaultdict(int)
        self.chupetines = 0
        self.salvado = False

        # Recibir dos dulces aleatorios
        for _ in range(2):
            tipo = random.choice(TIPOS_DULCES)
            self.dulces[tipo] += 1

    def mostrar_inventario(self):
        return f"{self.nombre}: A={self.dulces['A']}, B={self.dulces['B']}, C={self.dulces['C']} | Chupetines: {self.chupetines}"

    def canjear_dulces(self):
        if all(self.dulces[tipo] >= 1 for tipo in TIPOS_DULCES):
            for tipo in TIPOS_DULCES:
                self.dulces[tipo] -= 1
            self.chupetines += 1
            self.salvado = True
            extra = random.choice(TIPOS_DULCES)
            self.dulces[extra] += 1
            return f"Canjeado por chupet√≠n + {extra}"
        else:
            return "No tienes los tres tipos."

    def tiene_dulce(self, tipo):
        return self.dulces[tipo] > 0

    def quitar_dulce(self, tipo):
        if self.dulces[tipo] > 0:
            self.dulces[tipo] -= 1
            return True
        return False

    def dar_dulce(self, tipo):
        self.dulces[tipo] += 1

jugadores = []
</script>

<script>
let pyodideReady = false;
let jugadores = [];

async function iniciarJuego() {
  if (pyodideReady) {
    reiniciarJuego();
    return;
  }

  try {
    document.getElementById("gameArea").innerHTML = "<p>‚è≥ Cargando Pyodide...</p>";
    window.pyodide = await loadPyodide();
    const pythonCode = document.getElementById("py-src").textContent;
    await pyodide.runPythonAsync(pythonCode);

    // Crear jugadores
    const nombres = ["Ana ", "Beto ", "Carlos ","Harrison","Russbel","Danny","Brian","Cesia","Roberth"];
    let code = `
from js import Array
jugadores = [Jugador(nombre) for nombre in ${JSON.stringify(nombres)}]
len(jugadores)
    `;
    await pyodide.runPythonAsync(code);
    window.jugadoresList = await pyodide.globals.get("jugadores");

    // Mostrar interfaz
    mostrarInterfaz();
    pyodideReady = true;

  } catch (error) {
    console.error("Error al cargar Pyodide:", error);
    alert("Hubo un error al cargar el juego.");
  }
}

function mostrarInterfaz() {
  const contenedor = document.getElementById("gameArea");
  contenedor.innerHTML = "";

  // Lista de jugadores
  const lista = document.createElement("div");
  lista.style.marginBottom = "20px";
  lista.id = "listaJugadores";

  // Botones de acciones
  const acciones = document.createElement("div");

  // Bot√≥n Canjear
  const btnCanjear = document.createElement("button");
  btnCanjear.textContent = "‚ú® Canjear dulces";
  btnCanjear.onclick = () => seleccionarJugadorPara("canjear");
  acciones.appendChild(btnCanjear);

  // Bot√≥n Pedir
  const btnPedir = document.createElement("button");
  btnPedir.textContent = "üéÅ Pedir dulce";
  btnPedir.onclick = () => seleccionarJugadorPara("pedir");
  acciones.appendChild(btnPedir);

  // Bot√≥n Intercambiar
  const btnIntercambiar = document.createElement("button");
  btnIntercambiar.textContent = "üîÑ Intercambiar dulce";
  btnIntercambiar.onclick = () => seleccionarJugadorPara("intercambiar");
  acciones.appendChild(btnIntercambiar);

  // Mostrar jugadores
  contenedor.appendChild(acciones);
  mostrarJugadores();
}

function mostrarJugadores() {
  const contenedor = document.getElementById("listaJugadores");
  contenedor.innerHTML = "";

  for (let i = 0; i < 3; i++) {
    const jugador = pyodide.runPython(`jugadores[${i}].mostrar_inventario()`);

    const div = document.createElement("div");
    div.className = "player-card";

    div.innerHTML = `<strong>${jugador}</strong>`;
    contenedor.appendChild(div);
  }
}

function seleccionarJugadorPara(tipoAccion) {
  const contenedor = document.getElementById("gameArea");
  const div = document.createElement("div");
  div.style.marginTop = "20px";
  div.id = "acciones";

  const label = document.createElement("label");
  label.textContent = "Selecciona un jugador:";
  div.appendChild(label);

  const select = document.createElement("select");
  for (let i = 0; i < 3; i++) {
    const nombre = pyodide.runPython(`jugadores[${i}].nombre`);
    const option = document.createElement("option");
    option.value = i;
    option.textContent = nombre;
    select.appendChild(option);
  }
  div.appendChild(select);

  if (tipoAccion === "canjear") {
    const btn = document.createElement("button");
    btn.textContent = "Canjear";
    btn.onclick = () => realizarCanje(select.value);
    div.appendChild(btn);
  } else if (tipoAccion === "pedir") {
    const inputTipo = document.createElement("input");
    inputTipo.placeholder = "Ej: A";
    div.appendChild(inputTipo);

    const btn = document.createElement("button");
    btn.textContent = "Pedir";
    btn.onclick = () => pedirDulce(select.value, inputTipo.value.toUpperCase());
    div.appendChild(btn);
  } else if (tipoAccion === "intercambiar") {
    const inputTuyo = document.createElement("input");
    inputTuyo.placeholder = "Tu dulce (ej: A)";
    div.appendChild(inputTuyo);

    const inputOtro = document.createElement("input");
    inputOtro.placeholder = "Dulce a cambio (ej: B)";
    div.appendChild(inputOtro);

    const btn = document.createElement("button");
    btn.textContent = "Proponer intercambio";
    btn.onclick = () => proponerIntercambio(select.value, inputTuyo.value.toUpperCase(), inputOtro.value.toUpperCase());
    div.appendChild(btn);
  }

  const anterior = document.getElementById("acciones");
  if (anterior) anterior.remove();
  contenedor.appendChild(div);
}

async function realizarCanje(idx) {
  if (!idx && idx !== "0") return;

  try {
    const resultado = await pyodide.runPythonAsync(`jugadores[${idx}].canjear_dulces()`);
    mostrarMensaje(`Canje realizado: ${resultado}`, "success");
    mostrarJugadores();
  } catch (error) {
    console.error("Error al canjear:", error);
    mostrarMensaje("‚ùå No puedes canjear a√∫n", "error");
  }
}

async function pedirDulce(idxDestino, tipoPedido) {
  const idxOrigen = prompt("¬øDe qu√© jugador quieres pedir?");
  if (!idxOrigen || idxOrigen === "" || idxOrigen === idxDestino) {
    mostrarMensaje("‚ùå Selecci√≥n inv√°lida.", "error");
    return;
  }

  try {
    const tiene = await pyodide.runPythonAsync(`jugadores[${idxOrigen}].tiene_dulce("${tipoPedido}")`);
    if (!tiene) {
      mostrarMensaje("‚ùå El jugador no tiene ese dulce.", "error");
      return;
    }

    const confirmar = confirm(`¬ø${idxOrigen}, deseas darle un dulce "${tipoPedido}" a ${idxDestino}?`);
    if (confirmar) {
      await pyodide.runPythonAsync(`jugadores[${idxOrigen}].quitar_dulce("${tipoPedido}")`);
      await pyodide.runPythonAsync(`jugadores[${idxDestino}].dar_dulce("${tipoPedido}")`);
      mostrarMensaje(`üéâ Has recibido un dulce "${tipoPedido}"`, "success");
      mostrarJugadores();
    } else {
      mostrarMensaje("üö´ La solicitud fue rechazada.", "error");
    }
  } catch (error) {
    console.error("Error al pedir dulce:", error);
    mostrarMensaje("‚ùå Error al pedir el dulce", "error");
  }
}

async function proponerIntercambio(idxDestino, tipoTuyo, tipoOtro) {
  const idxOrigen = prompt("¬øCon qu√© jugador quieres intercambiar?");
  if (!idxOrigen || idxOrigen === "" || idxOrigen === idxDestino) {
    mostrarMensaje("‚ùå Selecci√≥n inv√°lida.", "error");
    return;
  }

  try {
    const tieneTuyo = await pyodide.runPythonAsync(`jugadores[${idxDestino}].tiene_dulce("${tipoTuyo}")`);
    const tieneOtro = await pyodide.runPythonAsync(`jugadores[${idxOrigen}].tiene_dulce("${tipoOtro}")`);

    if (!tieneTuyo || !tieneOtro) {
      mostrarMensaje("‚ùå Uno de los jugadores no tiene los dulces necesarios.", "error");
      return;
    }

    const confirmar = confirm(`¬ø${idxOrigen}, aceptas intercambiar "${tipoTuyo}" por "${tipoOtro}"?`);
    if (confirmar) {
      await pyodide.runPythonAsync(`jugadores[${idxDestino}].quitar_dulce("${tipoTuyo}")`);
      await pyodide.runPythonAsync(`jugadores[${idxOrigen}].quitar_dulce("${tipoOtro}")`);
      await pyodide.runPythonAsync(`jugadores[${idxDestino}].dar_dulce("${tipoOtro}")`);
      await pyodide.runPythonAsync(`jugadores[${idxOrigen}].dar_dulce("${tipoTuyo}")`);
      mostrarMensaje("üîÅ ¬°Intercambio realizado!", "success");
      mostrarJugadores();
    } else {
      mostrarMensaje("üö´ Intercambio cancelado.", "error");
    }
  } catch (error) {
    console.error("Error al intercambiar:", error);
    mostrarMensaje("‚ùå Error al intercambiar dulces", "error");
  }
}

function mostrarMensaje(mensaje, tipo) {
  const msgDiv = document.createElement("div");
  msgDiv.className = "message " + tipo;
  msgDiv.textContent = mensaje;
  const area = document.getElementById("gameArea");
  area.appendChild(msgDiv);
  setTimeout(() => msgDiv.remove(), 5000);
}

function reiniciarJuego() {
  location.reload();
}
</script>

</body>
</html>
