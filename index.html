<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🍭 Juego de Dulces - Intercambio Dulce</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Aquí puedes incluir tu estilo o dejarlo en style.css */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🍭 Juego de Dulces</h1>
      <p>¡Intercambia y colecciona dulces con tus amigos!</p>
      <button class="btn" onclick="iniciarJuego()" id="btnIniciar">
        🎮 Iniciar Juego
      </button>
    </div>

    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <p>Cargando el juego...</p>
    </div>

    <div id="gameContent" class="hidden">
      <div class="game-stats">
        <h3>📊 Estadísticas del Juego</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-number" id="totalPlayers">0</div>
            <div class="stat-label">Jugadores</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="totalCandies">0</div>
            <div class="stat-label">Dulces Totales</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="totalExchanges">0</div>
            <div class="stat-label">Intercambios</div>
          </div>
        </div>
      </div>

      <div class="game-controls">
        <div class="control-card">
          <h3>🔄 Canjear Dulces</h3>
          <select id="jugadorCanje">
            <option value="">Selecciona un jugador...</option>
          </select>
          <button class="btn btn-secondary" onclick="canjearDulce()">
            ✨ Realizar Canje
          </button>
          <div id="resultadoCanje"></div>
        </div>
        <div class="control-card">
          <h3>🎁 Dulce Extra</h3>
          <select id="tipoExtra">
            <option value="">Selecciona tipo...</option>
            <option value="A">🍬 Tipo A</option>
            <option value="B">🍭 Tipo B</option>
            <option value="C">🧁 Tipo C</option>
          </select>
          <button class="btn" onclick="elegirDulceExtra()" id="btnDulceExtra" disabled>
            🎯 Agregar Dulce Extra
          </button>
        </div>
        <div class="control-card">
          <h3>🎲 Acciones Adicionales</h3>
          <button class="btn btn-secondary" onclick="repartirDulces()">
            🎪 Repartir Dulces Aleatorios
          </button>
          <button class="btn" onclick="reiniciarJuego()">
            🔄 Reiniciar Juego
          </button>
        </div>
      </div>

      <div class="players-grid" id="jugadores"></div>
    </div>
  </div>

  <!-- Lógica del juego -->
  <script id="py-src" type="text/python">
class Jugador:
    def __init__(self, nombre):
        self.nombre = nombre
        self.dulces = {'A': 2, 'B': 2, 'C': 2}
        self.canjes_realizados = 0

    def mostrar_inventario(self):
        return f"{self.nombre}: A={self.dulces['A']}, B={self.dulces['B']}, C={self.dulces['C']}"

    def canjear_dulces(self):
        for tipo in ['A', 'B', 'C']:
            if self.dulces[tipo] >= 3:
                self.dulces[tipo] -= 3
                self.canjes_realizados += 1
                return True
        return False

    def dar_dulce_extra(self, tipo):
        if tipo in self.dulces:
            self.dulces[tipo] += 1

    def total_dulces(self):
        return sum(self.dulces.values())

    def dar_dulces_aleatorios(self):
        import random
        for tipo in ['A', 'B', 'C']:
            self.dulces[tipo] += random.randint(0, 3)
  </script>

  <script>
    let pyodideReady = false;
    let jugadorSeleccionado = null;
    let totalIntercambios = 0;
    let jugadores = [];

    async function iniciarPyodide() {
  try {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('btnIniciar').disabled = true;

    window.pyodide = await loadPyodide({
      indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/",
    });

    const pythonCode = document.getElementById("py-src").textContent;
    await pyodide.runPythonAsync(pythonCode);

    // Crear jugadores
    const nombres = [
      "Ana 👩", "Beto 👨", "Carlos 🧑",
      "Harrison 👨‍💼", "Russbel 👨‍🎓", "Brian 👨‍💻",
      "Cesia 👩‍🎨", "Roberth 👨‍🔧", "Danny 👨‍🎤"
    ];

    // 👇 Esta es la forma correcta de pasar la lista a Python
    pyodide.globals.set("nombres", nombres);

    const code = `
jugadores = [Jugador(nombre) for nombre in nombres]
`;
    await pyodide.runPythonAsync(code);

    jugadores = nombres; // aquí seguimos usando JS para mostrar y controlar
    pyodideReady = true;
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('gameContent').classList.remove('hidden');
    mostrarJugadores();
    actualizarEstadisticas();
    mostrarMensaje("¡Juego iniciado correctamente! 🎉", "success");

  } catch (error) {
    console.error("Error al cargar Pyodide:", error);
    mostrarMensaje("Error al cargar el juego. Revisa la consola.", "error");
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('btnIniciar').disabled = false;
  }
}


    function mostrarJugadores() {
      const contenedor = document.getElementById("jugadores");
      const select = document.getElementById("jugadorCanje");
      contenedor.innerHTML = "";
      select.innerHTML = '<option value="">Selecciona un jugador...</option>';

      for (let i = 0; i < jugadores.length; i++) {
        const jugador = pyodide.runPython(`jugadores[${i}]`);
        const inventario = pyodide.runPython(`jugadores[${i}].dulces`);
        const canjes = pyodide.runPython(`jugadores[${i}].canjes_realizados`);

        const div = document.createElement("div");
        div.className = "player-card";
        div.innerHTML = `
          <div class="player-name">${jugador.nombre} <span>(${canjes} canjes)</span></div>
          <div class="candy-item"><span>Tipo A</span><span>${inventario.get('A')}</span></div>
          <div class="candy-item"><span>Tipo B</span><span>${inventario.get('B')}</span></div>
          <div class="candy-item"><span>Tipo C</span><span>${inventario.get('C')}</span></div>
        `;
        contenedor.appendChild(div);

        const opt = document.createElement("option");
        opt.value = i;
        opt.text = jugador.nombre;
        select.appendChild(opt);
      }
    }

    function canjearDulce() {
      const idx = document.getElementById("jugadorCanje").value;
      if (!idx && idx !== "0") {
        mostrarMensaje("Por favor selecciona un jugador", "error");
        return;
      }

      try {
        const resultado = pyodide.runPython(`jugadores[${idx}].canjear_dulces()`);
        if (resultado) {
          jugadorSeleccionado = idx;
          totalIntercambios++;
          document.getElementById("btnDulceExtra").disabled = false;
          mostrarMensaje("¡Canje realizado! Elige tu dulce extra.", "success");
          mostrarJugadores();
          actualizarEstadisticas();
        } else {
          mostrarMensaje("❌ No tienes suficientes dulces para canjear (necesitas 3 del mismo tipo)", "error");
        }
      } catch (error) {
        console.error("Error en canje:", error);
        mostrarMensaje("Error al realizar el canje.", "error");
      }
    }

    function elegirDulceExtra() {
      const tipo = document.getElementById("tipoExtra").value;
      if (!tipo || jugadorSeleccionado === null) {
        mostrarMensaje("Primero realiza un canje válido", "error");
        return;
      }

      try {
        pyodide.runPython(`jugadores[${jugadorSeleccionado}].dar_dulce_extra("${tipo}")`);
        jugadorSeleccionado = null;
        document.getElementById("btnDulceExtra").disabled = true;
        document.getElementById("tipoExtra").value = "";
        document.getElementById("jugadorCanje").value = "";
        mostrarJugadores();
        actualizarEstadisticas();
        mostrarMensaje("🎉 ¡Dulce extra agregado!", "success");
      } catch (error) {
        console.error("Error al agregar dulce:", error);
        mostrarMensaje("Hubo un error al agregar el dulce extra.", "error");
      }
    }

    function repartirDulces() {
      try {
        for (let i = 0; i < jugadores.length; i++) {
          pyodide.runPython(`jugadores[${i}].dar_dulces_aleatorios()`);
        }
        mostrarJugadores();
        actualizarEstadisticas();
        mostrarMensaje("🎉 Dulces aleatorios repartidos a todos los jugadores", "success");
      } catch (error) {
        console.error("Error repartiendo dulces:", error);
        mostrarMensaje("Hubo un error al repartir dulces", "error");
      }
    }

    function reiniciarJuego() {
      location.reload();
    }

    function actualizarEstadisticas() {
      try {
        let totalDulces = 0;
        for (let i = 0; i < jugadores.length; i++) {
          const total = pyodide.runPython(`jugadores[${i}].total_dulces()`);
          totalDulces += total;
        }
        document.getElementById("totalPlayers").textContent = jugadores.length;
        document.getElementById("totalCandies").textContent = totalDulces;
        document.getElementById("totalExchanges").textContent = totalIntercambios;
      } catch (error) {
        console.error("Error actualizando estadísticas:", error);
      }
    }

    function mostrarMensaje(mensaje, tipo) {
      const contenedor = document.getElementById("resultadoCanje");
      contenedor.innerHTML = `<div class="message ${tipo}">${mensaje}</div>`;
      setTimeout(() => { contenedor.innerHTML = ""; }, 5000);
    }

    function iniciarJuego() {
      if (!pyodideReady) {
        iniciarPyodide();
      }
    }
  </script>
</body>
</html>
