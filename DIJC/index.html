<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Juego de Dulces</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js "></script>
</head>
<body>
  <h1>ðŸŽ® Juego de Dulces</h1>

  <button onclick="iniciarJuego()">Iniciar Juego</button>
  <div id="jugadores"></div>

  <h2>Canjear Dulces</h2>
  <select id="jugadorCanje"></select>
  <button onclick="canjearDulce()">Canjear</button>
  <p id="resultadoCanje"></p>

  <h2>Elegir Dulce Extra</h2>
  <select id="tipoExtra">
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
  </select>
  <button onclick="elegirDulceExtra()">Aceptar</button>

  <script>
    let pyodideReady = false;
    let jugadorSeleccionado = null;

    async function iniciarPyodide() {
      let pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip");
      window.pyodide = pyodide;
      console.log("Pyodide cargado");

      // Montar archivos
      pyodide.FS.writeFile("/game.py", document.getElementById("py-src").textContent);
      await pyodide.runPythonAsync(`
        from pathlib import Path
        import sys
        sys.path.append(str(Path("/").resolve()))
        import game
        jugadores = [game.Jugador(n) for n in ["Ana", "Beto", "Carlos", "Harrison", "Russbel", "Brian", "Cesia", "Roberth", "Danny"]]
        print("Juego iniciado")
        jugadores
      `).then((result) => {
        window.jugadores = result;
        mostrarJugadores();
      });
    }

    function mostrarJugadores() {
      const contenedor = document.getElementById("jugadores");
      contenedor.innerHTML = "";
      const select = document.getElementById("jugadorCanje");
      select.innerHTML = "";
      jugadores.forEach((j, i) => {
        const info = pyodide.runPython(`str(jugadores[${i}].mostrar_inventario())`);
        const div = document.createElement("div");
        div.textContent = info;
        contenedor.appendChild(div);

        const opt = document.createElement("option");
        opt.value = i;
        opt.text = j.nombre;
        select.appendChild(opt);
      });
    }

    function canjearDulce() {
      const idx = document.getElementById("jugadorCanje").value;
      const resultado = pyodide.runPython(`jugadores[${idx}].canjear_dulces()`);
      if (resultado) {
        document.getElementById("resultadoCanje").innerText = "Â¡Canjeado! Ahora elige tu dulce extra.";
        jugadorSeleccionado = idx;
      } else {
        alert("No puedes canjear aÃºn.");
      }
    }

    function elegirDulceExtra() {
      const tipo = document.getElementById("tipoExtra").value;
      if (!jugadorSeleccionado && jugadorSeleccionado !== 0) {
        alert("Primero realiza un canje vÃ¡lido.");
        return;
      }
      pyodide.runPython(`jugadores[${jugadorSeleccionado}].dar_dulce_extra("${tipo}")`);
      jugadorSeleccionado = null;
      document.getElementById("resultadoCanje").innerText = "Â¡Dulce extra agregado!";
      mostrarJugadores();
    }

    window.addEventListener("load", () => {
      fetch("game.py").then(r => r.text()).then(src => {
        const script = document.createElement("script");
        script.id = "py-src";
        script.type = "text/python";
        script.textContent = src;
        document.body.appendChild(script);
        iniciarPyodide();
      });
    });
  </script>
</body>
</html>
